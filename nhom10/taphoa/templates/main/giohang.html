{% extends 'main/base.html' %} 
{% load static %}

{% block linkcss %}
<link rel="stylesheet" type="text/css" href="{% static 'css/giohang.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/giohang1.css' %}" />

{% endblock %} 

{% block title%}Giỏ hàng{% endblock %} 
{% block secondnav %}{% endblock %}
{% block sanpham %}
<div class="giohang">
    <h1 class="text-center">Giỏ hàng</h1>

    <div class="box-element">
      <div class="cart-row">
        <div style="flex:1"></div>
        <div style="flex:2"><strong></strong></div>
        <div style="flex:1"><strong>Số lượng</strong></div>
        <div style="flex:1"><strong>Đơn giá</strong></div>
      </div>

      {% for item in items %}
      <div class="cart-row">
        <div style="flex:1">
          <img class="row-image" src="/media/{{item.product.image}}">
        </div>
        <div style="flex:2"><strong>{{item.product.product_name}}</strong></div>
        <div style="flex:1">
          <div class="quantity">
            <i class="fa-solid fa-square-minus update-cart" data-product="{{item.product.id}}" data-action="remove"></i>
            <p class="quantity-number">{{item.quantity}}</p>
            <i class="fa-solid fa-square-plus update-cart" data-product="{{item.product.id}}" data-action="add"></i>
          </div>
        </div>
        <div style="flex:1"><p>{{item.get_total}}</p></div>
      </div>
      {% endfor %}

      <div class="cart-row">
        <div style="flex:1"></div>
        <div style="flex:1"></div>
        <div style="flex:1"><strong>TỔNG: </strong></div>
        <div style="flex:1" class="cart-items"><strong>{{order.get_cart_items}}</strong></div>
        <div style="flex:1"><strong>{{order.get_cart_total}}</strong></div>
      </div>
    </div>

    <div class="d-grid gap-2 col-5 ms-auto">
      <a style="float:right; margin:5px;" class="btn btn-success" href="/thongtinmuahang/">Checkout</a>
    </div>
</div>

<script>
  // Lấy token CSRF từ meta
  const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  document.querySelectorAll('.update-cart').forEach(button => {
    button.addEventListener('click', function() {
      const productId = this.dataset.product;
      const action = this.dataset.action;

      fetch('/update_item/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({'product_id': productId, 'action': action}),
      })
      .then(response => response.json())
      .then(data => {
        if(data.status === 'success'){
          // Cập nhật số lượng trên trang
          const quantityElem = this.parentElement.querySelector('.quantity-number');
          let currentQuantity = parseInt(quantityElem.textContent);
          if(action === 'add') {
            currentQuantity += 1;
          } else if(action === 'remove') {
            currentQuantity = currentQuantity > 1 ? currentQuantity - 1 : 0;
          }
          quantityElem.textContent = currentQuantity;

          // Nếu số lượng = 0, có thể reload trang hoặc ẩn sản phẩm (tùy bạn)
          if(currentQuantity === 0) {
            // Reload trang để cập nhật giỏ hàng mới (đơn giản)
            location.reload();
          } else {
            // Cập nhật lại tổng tiền và tổng số món (nếu bạn muốn làm thêm)
            // Ở đây mình reload trang để đơn giản
          }
        } else {
          alert('Cập nhật giỏ hàng thất bại!');
        }
      })
      .catch(error => {
        console.error('Lỗi:', error);
        alert('Lỗi khi cập nhật giỏ hàng!');
      });
    });
  });
</script>

{% endblock %}
